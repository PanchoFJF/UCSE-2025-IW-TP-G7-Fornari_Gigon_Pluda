{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Actividades{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div>
  <h2>
    Actividades Vigentes
    <button class="btn btn-secondary mt-2 ms-2 float-end" title="Busqueda"
            data-bs-toggle="modal" data-bs-target="#buscarModal">
        <i class="bi bi-search"></i>
    </button>
  
    {% if request.user.is_superuser %}
    <button class="btn btn-success mt-2 float-end" title="Nueva Actividad"
            data-bs-toggle="modal" data-bs-target="#formActividad">
        <i class="bi bi-plus-lg"></i>
    </button>
    {% endif %}
  </h2>

  <!-- FILTROS -->
  <form method="get" class="mb-4 text-center">
    <select name="dia">
      <option value="">-- Día --</option>
      {% for d in dias %}
        <option value="{{ d }}" {% if filtros.dia == d %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>

    <select name="categoria">
      <option value="">-- Categoría --</option>
      {% for c in categorias %}
        <option value="{{ c }}" {% if filtros.categoria == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <select name="parroquia">
      <option value="">-- Parroquia --</option>
      {% for p in parroquias %}
        <option value="{{ p.nombre }}" {% if filtros.parroquia == p.nombre %}selected{% endif %}>
          {{ p.nombre }}
        </option>
      {% endfor %}
    </select>

    <select name="vencimiento">
      <option value="">-- Vencimiento --</option>
      <option value="con" {% if filtros.vencimiento == "con" %}selected{% endif %}>Con fecha</option>
      <option value="sin" {% if filtros.vencimiento == "sin" %}selected{% endif %}>Sin fecha</option>
    </select>

    <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
    {% if filtros.dia or filtros.categoria or filtros.parroquia or filtros.vencimiento %}
      <a href="." class="btn btn-danger btn-sm">Borrar filtros</a>
    {% endif %}
  </form>

    <!-- LISTADO DE ACTIVIDADES EN TARJETAS -->
    <div class="row mb-2">
      {% for actividad in actividades %}
        <div class="col-md-6 mb-4">
          <!-- Cada actividad ocupa media fila -->
          <div class="row g-0 border rounded overflow-hidden flex-md-row shadow-sm h-md-250 position-relative" style="background-color: #E8E3D0;">
            <div class="col p-4 d-flex flex-column position-static">
              <h3 class="mb-0">{{ actividad.titulo }}</h3>
              <div class="mb-1 text-body-secondary">Fecha: {{ actividad.dia }}</div>
              <div class="mb-1 text-body-secondary">Hora: {{ actividad.hora }}</div>
              <p class="card-text mb-auto">Descripción: {{ actividad.texto|truncatechars:100 }}</p>
              
              <!-- Botón más info -->
              <button class="btn btn-info btn-sm mt-2"
                      data-bs-toggle="modal"
                      data-bs-target="#detalleModal"
                      data-titulo="{{ actividad.titulo }}"
                      data-categoria="{{ actividad.categoria }}"
                      data-dia="{{ actividad.dia }}"
                      data-hora="{{ actividad.hora }}"
                      data-iglesia="{{ actividad.parroquia }}"
                      data-texto="{{ actividad.texto }}"
                      data-fechavencimiento="{{ actividad.fecha_vencimiento }}">
                ℹ️ Más info
              </button>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center">No hay actividades vigentes.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Detalle de la Actividad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Título:</strong> <span id="detalleTitulo"></span></p>
        <p><strong>Categoría:</strong> <span id="detalleCategoria"></span></p>
        <p><strong>Día:</strong> <span id="detalleDia"></span></p>
        <p><strong>Hora:</strong> <span id="detalleHora"></span></p>
        <p><strong>Iglesia:</strong> <span id="detalleIglesia"></span></p>
        <p><strong>Descripción:</strong> <span id="detalleTexto"></span></p>
        <p><strong>Vencimiento:</strong> <span id="detalleVencimiento"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Crear Actividad -->
<div class="modal fade" id="formActividad" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background-color: #E8E3D0;">
      <div class="modal-header" style="background-color: #d0ccbb;">
        <h5 class="modal-title">Nueva Actividad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="formCrearActividad">
          {% csrf_token %}
          {{ form.as_p }}
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success w-100" form="formCrearActividad">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var detalleModal = document.getElementById('detalleModal')
    detalleModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        document.getElementById('detalleTitulo').textContent = button.getAttribute('data-titulo')
        document.getElementById('detalleCategoria').textContent = button.getAttribute('data-categoria')
        document.getElementById('detalleDia').textContent = button.getAttribute('data-dia')
        document.getElementById('detalleHora').textContent = button.getAttribute('data-hora')
        document.getElementById('detalleIglesia').textContent = button.getAttribute('data-iglesia')
        document.getElementById('detalleTexto').textContent = button.getAttribute('data-texto')
        document.getElementById('detalleVencimiento').textContent = button.getAttribute('data-fechavencimiento')
    })
})

// AJAX búsqueda
$(document).ready(function(){
    $('#formBusqueda').on('submit', function(e){
        e.preventDefault();
        let query = $(this).find('input[name="q"]').val();
        if(!query.trim()){ return; }

        $('#resultadosBusqueda').html('<p class="text-center text-muted">Buscando...</p>');
        $.get("{% url 'haystack_search' %}", { q: query }, function(data){
            // Extraemos los resultados del template renderizado
            let resultados = $(data).find('.main-content, #content, body').html();
            $('#resultadosBusqueda').html(resultados || '<p>No se encontraron resultados.</p>');
        });
    });

    // Detalle AJAX de actividad desde resultado
    $(document).on('click', '.actividad-link', function(e){
        e.preventDefault();
        let actividadId = $(this).data('id');

        $.get("{% url 'sitio:actividad_ajax' 0 %}".replace('0', actividadId), function(data){
            if(data.error){
                alert(data.error);
            } else {
                $('#buscarModal').modal('hide');
                $('#detalleTitulo').text(data.titulo);
                $('#detalleCategoria').text(data.categoria);
                $('#detalleDia').text(data.dia);
                $('#detalleHora').text(data.hora);
                $('#detalleIglesia').text(data.iglesia);
                $('#detalleTexto').text(data.texto);
                $('#detalleVencimiento').text(data.fechaVencimiento);
                new bootstrap.Modal(document.getElementById('detalleModal')).show();
            }
        });
    });
});
</script>
{% endblock %}
