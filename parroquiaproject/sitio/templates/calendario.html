{% extends "base.html" %}
{% load static %}

{% block title %}Calendario{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<!-- Asegurate de tener Bootstrap 5 si querés el modal (o incluilo aquí) -->
{% endblock %}

{% block content %}
  <h2 class="text-center mb-3">Calendario de Actividades</h2>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <a href="?year={{ year }}&month={{ month|add:"-1" }}" class="btn btn-outline-secondary btn-sm">←</a>
    <h4 class="m-0">{{ nombre_mes }} {{ year }}</h4>
    <a href="?year={{ year }}&month={{ month|add:"1" }}" class="btn btn-outline-secondary btn-sm">→</a>
  </div>

  <!-- Encabezado de días (L..D) -->
  <div class="week-header calendar-grid text-center fw-bold mb-1">
    <div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div>
  </div>

  <!-- Semanas -->
  <div class="month-container">
    {% for week in weeks %}
      <div class="week-row">
        {% for cell in week %}
          {% if cell.in_current_month %}
            <div class="day-card {% if cell.activities %}has-activity{% endif %}">
              <div class="day-number">{{ cell.number }}</div>
              <div class="activity-list">
                {% for act in cell.activities %}
                  <!-- data-attrs urlencoded para decodificar con JS -->
                  <a href="#" class="activity-link d-block"
                     data-title="{{ act.titulo|urlencode }}"
                     data-text="{{ act.texto|default_if_none:''|urlencode }}"
                     data-hora="{{ act.hora|default_if_none:''|urlencode }}"
                     data-iglesia="{{ act.iglesia.nombre|default_if_none:''|urlencode }}">
                    {{ act.titulo }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <!-- día de otro mes (más tenue) -->
            <div class="day-card other-month">
              <div class="day-number muted">{{ cell.number }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- Modal Bootstrap para ver detalle -->
  <div class="modal fade" id="activityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="activityModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="activityModalBody"></div>
        <div class="modal-footer">
          <small id="activityExtra" class="me-auto text-muted"></small>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Grid */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .week-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom:6px; }

    /* Cards */
    .day-card {
      background-color: #E8E3D0;
      border-radius: 8px;
      padding: 6px;
      min-height: 86px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
    }
    .day-card.other-month { opacity: 0.45; background-color: #f5f5f5; }
    .day-card.has-activity { border: 2px solid #6b705c; }

    .day-number { font-weight: 700; font-size: 0.95rem; margin-bottom:6px; color:#333; }
    .day-number.muted { color: #777; font-weight: 600; }

    .activity-list { font-size: 0.85rem; }
    .activity-link {
      display:block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      text-decoration: none;
      color: #2b2b2b;
    }
    .activity-link:hover { text-decoration: underline; color: #0b5ed7; }

    .week-header { margin-bottom: 8px; }
  </style>

  <script>
    // Requiere Bootstrap 5 JS cargado en la plantilla base.
    (function(){
      const modalEl = document.getElementById('activityModal');
      let bsModal = null;
      if (modalEl) {
        // crear instancia lazy
        bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
      }

      // Decodifica un valor urlencoded o devuelve cadena vacía
      function safeDecode(v){
        try { return decodeURIComponent(v || ""); } catch(e) { return v || ""; }
      }

      document.querySelectorAll('.activity-link').forEach(function(el){
        el.addEventListener('click', function(ev){
          ev.preventDefault();
          const title = safeDecode(this.dataset.title);
          const text = safeDecode(this.dataset.text);
          const hora = safeDecode(this.dataset.hora);
          const iglesia = safeDecode(this.dataset.iglesia);

          document.getElementById('activityModalLabel').textContent = title || "Actividad";
          let bodyHtml = "";
          if (hora) bodyHtml += "<p><strong>Hora:</strong> " + hora + "</p>";
          if (iglesia) bodyHtml += "<p><strong>Iglesia:</strong> " + iglesia + "</p>";
          if (text) bodyHtml += "<p>" + text + "</p>";

          document.getElementById('activityModalBody').innerHTML = bodyHtml || "<p>(sin descripción)</p>";
          document.getElementById('activityExtra').textContent = "";

          if (bsModal) bsModal.show();
        });
      });
    })();
  </script>
{% endblock %}
